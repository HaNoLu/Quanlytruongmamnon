{% extends 'layout/base.html' %}
{% block title %}Ghi nhận sức khỏe hàng ngày{% endblock %}
{% block content %}
<h1 class="subject">Ghi nhận sức khỏe hàng ngày</h1>

<div class="container mb-3">
    <form action="{{ url_for('health') }}" method="get" class="form-inline">
        <label class="mr-2 font-weight-bold">Chọn lớp:</label>
        <select name="class_id" class="form-control mr-2">
            <option value="">-- Chọn lớp --</option>
            {% for c in classes %}
            <option value="{{ c.id }}" {% if class_id|int == c.id %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-success">Xem danh sách</button>
    </form>
</div>

{% if children %}
<form action="{{ url_for('save_batch_health') }}" method="post">
    <input type="hidden" name="class_id_hidden" value="{{ class_id }}">

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">Danh sách trẻ</h6>
            <button type="submit" class="btn btn-primary font-weight-bold">
                <i class="fa fa-save"></i> LƯU
            </button>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-hover">
                <thead class="thead-light">
                    <tr>
                        <th width="20%">Họ tên trẻ</th>
                        <th width="15%">Cân nặng (kg)</th>
                        <th width="15%">Nhiệt độ (°C)</th>
                        <th width="15%">Trạng thái</th> <th>Ghi chú</th>
                    </tr>
                </thead>
                <tbody>
                    {% for child in children %}
                    {% set record = health_data.get(child.id) %}
                    
                    <tr {% if record %}class="table-success"{% endif %}> 
                        <td class="font-weight-bold align-middle">{{ child.fullname }}</td>
                        
                        <td>
                            <input type="number" step="0.1" 
                                   name="weight_{{child.id}}" 
                                   class="form-control" placeholder="Kg"
                                   value="{{ record.weight if record else '' }}">
                        </td>
                        
                        <td>
                            <input type="number" step="0.1" 
                                   name="temp_{{child.id}}" 
                                   class="form-control" placeholder="°C"
                                   value="{{ record.temperature if record else '' }}"
                                   id="temp_{{child.id}}" 
                                   oninput="checkFever({{child.id}})">
                        </td>

                        <td class="align-middle text-center">
                            <span id="status_{{child.id}}" class="badge badge-secondary p-2">Chưa nhập</span>
                        </td>

                        <td>
                            <input type="text" 
                                   name="note_{{child.id}}" 
                                   class="form-control" 
                                   value="{{ record.note if record else 'Bình thường' }}">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<div class="alert alert-warning mt-3">
    <strong>Quy định:</strong> Nhiệt độ trên <strong>37.5°C</strong> hệ thống sẽ cảnh báo sốt.
</div>

<script>
    function checkFever(id) {
        let tempInput = document.getElementById('temp_' + id);
        let statusLabel = document.getElementById('status_' + id);
        
        if (!tempInput || !statusLabel) return;

        let val = tempInput.value;
        let temp = parseFloat(val);

        if (!val) {
            statusLabel.className = "badge badge-secondary p-2";
            statusLabel.innerText = "Chưa nhập";
            return;
        }

        if (temp > 37.5) {
            statusLabel.className = "badge badge-danger p-2";
            statusLabel.innerText = "CẢNH BÁO SỐT";
        } else {
            statusLabel.className = "badge badge-success p-2";
            statusLabel.innerText = "Ổn định";
        }
    }

    window.onload = function() {
        {% if children %}
            {% for child in children %}
                if (document.getElementById('temp_{{child.id}}').value) {
                    checkFever({{child.id}});
                }
            {% endfor %}
        {% endif %}
    };
</script>

{% endif %}
{% endblock %}