{% extends 'layout/base.html' %}
{% block title %}Thu học phí{% endblock %}
{% block content %}
<h1 class="subject">Thu học phí</h1>

<div class="card mb-4 shadow-sm">
    <div class="card-body bg-light">
        <form action="{{ url_for('tuition') }}" method="get">
            <div class="form-row align-items-end">
                <div class="col-md-4">
                    <label>Chọn Lớp:</label>
                    <select name="class_id" class="form-control" onchange="this.form.submit()">
                        <option value="">-- Chọn lớp --</option>
                        {% for c in classes %}
                        <option value="{{ c.id }}" {% if class_id|int==c.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Tháng:</label>
                    <select name="month" class="form-control">
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>Tháng {{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label>Năm:</label>
                    <input type="number" name="year" class="form-control" value="{{ selected_year }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary btn-block">Áp dụng</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% if children %}
<form action="{{ url_for('save_batch_tuition') }}" method="post">
    <input type="hidden" name="class_id_hidden" value="{{ class_id }}">
    <input type="hidden" name="month_hidden" value="{{ selected_month }}">
    <input type="hidden" name="year_hidden" value="{{ selected_year }}">

    <div class="card shadow">
        <div class="card-header d-flex justify-content-between">
            <h5 class="m-0 font-weight-bold text-primary">Bảng thu phí Tháng {{ selected_month }}/{{ selected_year }}
            </h5>
            <button type="submit" class="btn btn-success font-weight-bold">
                <i class="fa fa-save"></i> LƯU
            </button>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead class="thead-dark">
                    <tr>
                        <th>Tên trẻ</th>
                        <th>Số ngày ăn</th>
                        <th>Tổng tiền (VNĐ)</th>
                        <th class="text-center">Trạng thái</th>
                        <th class="text-center">Hóa đơn</th>
                    </tr>
                </thead>
                <tbody>
                    {% for child in children %}
                    {% set receipt = receipt_data.get(child.id) %}
                    {% set is_paid = receipt.status if receipt else False %}
                    {% set days = receipt.meal_days if receipt else 22 %}
                    {% set total = receipt.total_amount if receipt else 2050000 %}

                    <tr {% if is_paid %}style="background-color: #d4edda" {% endif %}>
                        <td class="align-middle font-weight-bold">{{ child.fullname }}</td>

                        <td>
                            <input type="number" name="meal_days_{{child.id}}" class="form-control text-center"
                                value="{{ days }}" min="0" max="31" oninput="calcTotal({{child.id}})"
                                id="days_{{child.id}}" {% if is_paid %}readonly{% endif %}>
                        </td>

                        <td class="align-middle text-danger font-weight-bold">
                            <span id="total_{{child.id}}">{{ "{:,.0f}".format(total).replace(',', '.') }}</span>
                        </td>

                        <td class="text-center align-middle">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="paid_{{child.id}}"
                                    name="paid_{{child.id}}" {% if is_paid %}checked{% endif %}>
                                <label class="custom-control-label" for="paid_{{child.id}}">Đã nộp</label>
                            </div>
                        </td>

                        <td class="text-center">
                            {% if is_paid %}
                            <a href="{{ url_for('print_receipt', child_id=child.id, month=selected_month, year=selected_year) }}"
                                class="btn btn-warning btn-sm" title="In hóa đơn" target="_blank"> <i
                                    class="fa fa-print"></i> In
                            </a>
                            {% else %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

<script>
    function calcTotal(id) {
        let daysInput = document.getElementById('days_' + id);
        let days = parseInt(daysInput.value) || 0;
        let basicFee = base_tuition;
        let mealPrice = mealPrice;
        let total = basicFee + (days * mealPrice);
        document.getElementById('total_' + id).innerText = total.toLocaleString('vi-VN').replace(/,/g, '.');
    }
</script>
{% endif %}
{% endblock %}